[gcode_macro CAMBIO_COLORE]
description: Cambio colore con purge e pulizia dopo la pausa
gcode:
    {% set x_wipe = 290 %}
    {% set y_wipe = 10 %}
    {% set z_lift = 5 %}
    {% set purge_len = 50 %}
    {% set clean_line = 30 %}
    {% set clean_extrude = 2 %}
    {% set initial_z = printer.toolhead.position.z %}

    ; Solleva lâ€™ugello
    G91
    G1 Z{z_lift} F1000
    G90

    ; Spostati nella zona sicura
    G1 X{x_wipe} Y{y_wipe} F6000

    ; Mostra messaggio all'utente
    RESPOND PREFIX="Cambio Colore" MSG="Cambia filamento e premi Resume per continuare"

    ; Pausa per cambio filamento
    M600

    ; Dopo il Resume
    G1 Z0.2 F1000                  ; avvicina al piano
    G92 E0                         ; azzera estrusore
    G1 E{purge_len} F300           ; spurga filamento
    G1 X{clean_line} E{clean_extrude} F800  ; linea di pulizia con estrusione
    G92 E0                         ; resetta estrusore
    G1 Z{initial_z} F1000          ; ritorna alla Z originale